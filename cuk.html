<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Katalog Produk ForestAPI</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { text-align: center; }
    .nav { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .nav button { padding: 8px 12px; border: none; background: #eee; cursor: pointer; }
    .nav button.active { background: #333; color: #fff; }
    .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .product { border: 1px solid #ccc; padding: 10px; border-radius: 10px; }
    .product button { margin-top: 10px; }
    #checkout { margin-top: 30px; padding: 20px; border: 1px solid #aaa; border-radius: 10px; display: none; }
    .notif { padding: 10px; background: lightgreen; border-radius: 5px; margin-top: 10px; display: none; }
    .animate-success { animation: pop 0.6s ease-in-out; }
    @keyframes pop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>Katalog Produk Digital</h1>
  <div class="nav" id="categoryNav"></div>
  <div class="nav" id="providerNav"></div>
  <div class="product-list" id="productList">Memuat produk...</div>

  <div id="checkout">
    <h3>Checkout Produk</h3>
    <p id="checkoutProduct"></p>
    <div id="extraInput" style="display: none;">
      <input type="text" id="userId" placeholder="User ID" />
      <input type="text" id="zoneId" placeholder="Zone ID" />
    </div>
    <input type="text" id="target" placeholder="Masukkan Nomor Tujuan / User ID" />
    <button id="bayarBtn">Bayar Sekarang</button>
    <div id="qrArea" style="margin-top: 15px;"></div>
    <button id="batalBtn" style="display:none; margin-top:10px;">Batalkan Pesanan</button>
    <div class="notif" id="notifBox"></div>
  </div>

  <script>
    const API_KEY = "sk-rj6hylkrbx3qio";
    let allProducts = [], activeCategory = '', activeProvider = '';
    let currentTx = null, polling = null;

    async function fetchProducts() {
      try {
        const res = await fetch("https://forestapi.web.id/api/h2h/price-list/all", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ api_key: API_KEY, filter_status: true })
        });
        const data = await res.json();
        allProducts = data.data;
        renderCategories();
        renderProviders();
        renderProducts();
      } catch {
        document.getElementById("productList").innerHTML = "Gagal memuat produk.";
      }
    }

    function renderCategories() {
      const cats = [...new Set(allProducts.map(p => p.category))];
      const nav = document.getElementById("categoryNav");
      nav.innerHTML = '';
      cats.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.onclick = () => {
          activeCategory = cat;
          activeProvider = '';
          renderProviders();
          renderProducts();
          updateActiveBtns();
        };
        nav.appendChild(btn);
      });
    }

    function renderProviders() {
      const prov = [...new Set(allProducts
        .filter(p => !activeCategory || p.category === activeCategory)
        .map(p => p.provider))];
      const nav = document.getElementById("providerNav");
      nav.innerHTML = '';
      prov.forEach(pv => {
        const btn = document.createElement("button");
        btn.textContent = pv;
        btn.onclick = () => {
          activeProvider = pv;
          renderProducts();
          updateActiveBtns();
        };
        nav.appendChild(btn);
      });
    }

    function updateActiveBtns() {
      document.querySelectorAll("#categoryNav button").forEach(btn => {
        btn.classList.toggle("active", btn.textContent === activeCategory);
      });
      document.querySelectorAll("#providerNav button").forEach(btn => {
        btn.classList.toggle("active", btn.textContent === activeProvider);
      });
    }

    function renderProducts() {
      const list = document.getElementById("productList");
      const filtered = allProducts.filter(p =>
        (!activeCategory || p.category === activeCategory) &&
        (!activeProvider || p.provider === activeProvider)
      );
      if (filtered.length === 0) {
        list.innerHTML = "Tidak ada produk.";
        return;
      }
      list.innerHTML = '';
      filtered.forEach(p => {
        const el = document.createElement("div");
        el.className = "product";
        el.innerHTML = `<strong>${p.name}</strong><br>${p.formatted_price}<br><small>${p.note || ''}</small><br><button>Beli Sekarang</button>`;
        el.querySelector("button").onclick = () => startCheckout(p);
        list.appendChild(el);
      });
    }

    function startCheckout(product) {
      document.getElementById("checkout").style.display = 'block';
      document.getElementById("checkoutProduct").textContent = product.name;
      document.getElementById("qrArea").innerHTML = '';
      document.getElementById("target").value = '';
      document.getElementById("batalBtn").style.display = 'none';
      document.getElementById("notifBox").style.display = 'none';
      document.getElementById("extraInput").style.display = product.code.startsWith("ML") ? 'block' : 'none';
      document.getElementById("bayarBtn").onclick = () => makeTransaction(product);
    }

    async function makeTransaction(product) {
      let target = document.getElementById("target").value;
      if (product.code.startsWith("ML")) {
        const uid = document.getElementById("userId").value;
        const zid = document.getElementById("zoneId").value;
        if (!uid || !zid) return alert("Isi User ID dan Zone ID.");
        target = `${uid}|${zid}`;
      }
      const reff = `tx-${Date.now()}`;
      const depositRes = await fetch("https://forestapi.web.id/api/h2h/deposit/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nominal: product.price,
          method: "QRISFAST",
          reff_id: reff,
          api_key: API_KEY
        })
      });
      const deposit = await depositRes.json();
      if (deposit.status !== "success") return alert("Gagal membuat QRIS.");

      document.getElementById("qrArea").innerHTML = `<img src="${deposit.data.qr_image_url}" width="200"/><p>Status: <span id="statusText">pending</span></p>`;
      document.getElementById("batalBtn").style.display = 'inline-block';
      currentTx = { id: deposit.data.id, reff_id: reff, product, target };
      polling = setInterval(() => checkStatus(), 3000);

      document.getElementById("batalBtn").onclick = async () => {
        clearInterval(polling);
        await fetch("https://forestapi.web.id/api/h2h/deposit/cancel", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: currentTx.id, api_key: API_KEY })
        });
        document.getElementById("statusText").textContent = "dibatalkan";
        document.getElementById("batalBtn").style.display = 'none';
      };
    }

    async function checkStatus() {
      // Simulasi pengecekan sukses pakai polling random (karena API tidak sediakan endpoint status)
      if (Math.random() < 0.2) {
        clearInterval(polling);
        document.getElementById("statusText").textContent = "success";
        document.getElementById("notifBox").textContent = "Pembayaran berhasil!";
        document.getElementById("notifBox").classList.add("animate-success");
        document.getElementById("notifBox").style.display = "block";

        await fetch("https://forestapi.web.id/api/h2h/transaction/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            target: currentTx.target,
            product_code: currentTx.product.code,
            reff_id: currentTx.reff_id,
            api_key: API_KEY
          })
        });
        document.getElementById("batalBtn").style.display = 'none';
      }
    }

    fetchProducts();
  </script>
</body>
</html>
