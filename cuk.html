<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vinzz PPOB</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root {
      --primary: #2962ff;
    }
    .navbar { background: var(--primary); }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark px-3">
    <span class="navbar-brand">VINZZ PPOB</span>
    <div class="text-white" id="balance">Saldo: Rp0</div>
  </nav>

  <div class="container my-4">
    <button class="btn btn-success mb-3" onclick="openDeposit()">Deposit QRIS</button>

    <div id="loading" class="text-center d-none">
      <div class="loader"></div>
      <p>Memuat produk...</p>
    </div>

    <div class="row" id="products-container"></div>
  </div>

  <!-- Modal Transaksi -->
  <div class="modal fade" id="modalTransaksi" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form onsubmit="submitTransaksi(event)">
          <div class="modal-header">
            <h5 class="modal-title">Beli Produk</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="productCode" />
            <div class="mb-3">
              <label>User ID / No Tujuan</label>
              <input type="text" class="form-control" id="target" required />
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" type="submit">Beli Sekarang</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Deposit -->
  <div class="modal fade" id="modalDeposit" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form onsubmit="submitDeposit(event)">
          <div class="modal-header">
            <h5 class="modal-title">Deposit QRIS</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="number" id="depositNominal" class="form-control" placeholder="Masukkan nominal" required />
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" type="submit">Buat QRIS</button>
          </div>
        </form>
        <div id="qrisContainer" class="text-center p-3 d-none">
          <img id="qrisImage" src="" style="max-width: 100%;"/>
          <p class="mt-2">Scan QR untuk membayar</p>
          <button class="btn btn-danger" onclick="cancelDeposit()">Batalkan</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_KEY = "sk-rj6hylkrbx3qio";
    let currentDepositId = "";

    async function loadProducts() {
      try {
        toggleLoading(true);
        const res = await fetch("https://forestapi.web.id/api/h2h/price-list/all", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            api_key: API_KEY,
            filter_status: "true",
            profit_percent: "1"
          })
        });
        const data = await res.json();
        if (data.status === "success") {
          renderProducts(data.data);
        } else {
          alert("Gagal memuat produk");
        }
      } catch (err) {
        alert("Gagal memuat produk: " + err.message);
      } finally {
        toggleLoading(false);
      }
    }

    function renderProducts(list) {
      const container = document.getElementById("products-container");
      container.innerHTML = "";
      list.forEach(p => {
        const col = document.createElement("div");
        col.className = "col-md-4 mb-3";
        col.innerHTML = `
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">${p.name}</h5>
              <p>${p.provider}</p>
              <p class="text-success">${p.formatted_price}</p>
              <button class="btn btn-primary" onclick="openTransaksi('${p.code}')">Beli</button>
            </div>
          </div>
        `;
        container.appendChild(col);
      });
    }

    function toggleLoading(show) {
      document.getElementById("loading").classList.toggle("d-none", !show);
      document.getElementById("products-container").classList.toggle("d-none", show);
    }

    function openTransaksi(code) {
      document.getElementById("productCode").value = code;
      document.getElementById("target").value = "";
      new bootstrap.Modal(document.getElementById("modalTransaksi")).show();
    }

    async function submitTransaksi(e) {
      e.preventDefault();
      const code = document.getElementById("productCode").value;
      const target = document.getElementById("target").value;
      try {
        const res = await fetch("https://forestapi.web.id/api/h2h/transaction/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            api_key: API_KEY,
            product_code: code,
            target: target,
            reff_id: "trx-" + Date.now()
          })
        });
        const result = await res.json();
        if (result.status === "success") {
          alert("Transaksi Berhasil!\nSN: " + result.data.serial_number);
          bootstrap.Modal.getInstance(document.getElementById("modalTransaksi")).hide();
        } else {
          alert(result.message);
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    function openDeposit() {
      document.getElementById("depositNominal").value = "";
      document.getElementById("qrisContainer").classList.add("d-none");
      new bootstrap.Modal(document.getElementById("modalDeposit")).show();
    }

    async function submitDeposit(e) {
      e.preventDefault();
      const nominal = document.getElementById("depositNominal").value;
      try {
        const res = await fetch("https://forestapi.web.id/api/h2h/deposit/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            api_key: API_KEY,
            nominal: parseInt(nominal),
            method: "QRISFAST",
            fee_by_customer: "false",
            reff_id: "deposit-" + Date.now()
          })
        });
        const result = await res.json();
        if (result.status === "success") {
          document.getElementById("qrisImage").src = result.data.qr_image_url;
          document.getElementById("qrisContainer").classList.remove("d-none");
          currentDepositId = result.data.id;
        } else {
          alert(result.message);
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    async function cancelDeposit() {
      if (!currentDepositId) return;
      try {
        const res = await fetch("https://forestapi.web.id/api/h2h/deposit/cancel", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            api_key: API_KEY,
            id: currentDepositId
          })
        });
        const result = await res.json();
        if (result.status === "success") {
          alert("Deposit dibatalkan");
          document.getElementById("qrisContainer").classList.add("d-none");
        } else {
          alert(result.message);
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    loadProducts();
  </script>
</body>
</html>
