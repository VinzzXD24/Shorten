<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Katalog Produk Digital</title>
  <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { margin: 0; background: #f4f4f4; color: #333; }
    header { background: #2c3e50; color: white; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 999; }
    .categories, .subcategories { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin: 1rem; }
    .categories button, .subcategories button {
      background: #3498db; border: none; padding: 0.5rem 1rem; border-radius: 20px; color: white; cursor: pointer;
    }
    .product-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; padding: 1rem; }
    .product-card {
      background: white; padding: 1rem; border-radius: 1rem; width: 220px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .product-card button {
      background: #e74c3c; color: white; border: none; padding: 0.5rem; border-radius: 8px; cursor: pointer;
    }
    .input-field { margin-top: 0.5rem; }
    #popupQRIS {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .popup-content {
      background: white; padding: 1.5rem; border-radius: 1rem; max-width: 90%; text-align: center;
      animation: slideDown 0.5s ease;
    }
    @keyframes slideDown { from { transform: translateY(-100px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
    .status-pending { color: orange; font-weight: bold; }
    .status-success { color: green; font-weight: bold; animation: pulse 1s infinite; }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1 }
      50% { transform: scale(1.05); opacity: 0.7 }
      100% { transform: scale(1); opacity: 1 }
    }
    #scrollTopBtn {
      position: fixed; bottom: 20px; right: 20px; background: #f39c12; color: white; border: none;
      padding: 10px 15px; border-radius: 50%; font-size: 1.2rem; cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>Katalog Produk Digital</h1>
  </header>
  <div class="categories" id="categoryTabs"></div>
  <div class="subcategories" id="subcategoryTabs"></div>
  <div class="product-list" id="productList"></div>

  <div id="popupQRIS">
    <div class="popup-content">
      <h3>Scan QRIS untuk Pembayaran</h3>
      <img id="qrImage" src="" width="200"/>
      <p id="hargaDetail"></p>
      <p id="statusPembayaran" class="status-pending">Menunggu Pembayaran...</p>
      <button onclick="cancelDeposit()">Batalkan Pesanan</button>
      <button onclick="closePopup()">Tutup</button>
    </div>
  </div>

  <button id="scrollTopBtn" onclick="scrollToTop()">â†‘</button>

  <script>
    const API_KEY = "sk-rj6hylkrbx3qio";
    let allProducts = [], currentDepositId = "", pollingInterval;

    async function fetchProducts() {
      const res = await fetch("https://forestapi.web.id/api/h2h/price-list/all", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ api_key: API_KEY, filter_status: false })
      });
      const data = await res.json();
      if (data.status === "success") {
        allProducts = data.data;
        renderCategories();
      }
    }

    function renderCategories() {
      const categorySet = new Set(allProducts.map(p => p.category));
      document.getElementById("categoryTabs").innerHTML = "";
      categorySet.forEach(cat => {
        const btn = document.createElement("button");
        btn.innerText = cat;
        btn.onclick = () => renderSubcategories(cat);
        document.getElementById("categoryTabs").appendChild(btn);
      });
    }

    function renderSubcategories(category) {
      const providers = [...new Set(allProducts.filter(p => p.category === category).map(p => p.provider))];
      document.getElementById("subcategoryTabs").innerHTML = "";
      providers.forEach(provider => {
        const btn = document.createElement("button");
        btn.innerText = provider;
        btn.onclick = () => renderProducts(category, provider);
        document.getElementById("subcategoryTabs").appendChild(btn);
      });
    }

    function renderProducts(category, provider) {
      const container = document.getElementById("productList");
      container.innerHTML = "";
      const filtered = allProducts.filter(p => p.category === category && p.provider === provider);
      filtered.forEach(prod => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <b>${prod.name}</b>
          <small>${prod.note || ""}</small>
          <p>${prod.formatted_price}</p>
          <div class="input-field">
            ${prod.category === "Games" && prod.provider.includes("MOBILE") ?
              `<input type="text" placeholder="User ID" id="uid-${prod.code}" />
               <input type="text" placeholder="Zone ID" id="zone-${prod.code}" />`
              : `<input type="text" placeholder="No. Tujuan" id="uid-${prod.code}" />`
            }
          </div>
          <button onclick="beliSekarang('${prod.code}', ${prod.price}, '${prod.category}', '${prod.provider}')">Beli Sekarang</button>
        `;
        container.appendChild(card);
      });
    }

    async function beliSekarang(code, price, category, provider) {
      const uid = document.getElementById("uid-" + code)?.value || "";
      const zone = document.getElementById("zone-" + code)?.value || "";
      if (!uid || (category === "Games" && provider.includes("MOBILE") && !zone)) return alert("Lengkapi ID terlebih dahulu.");

      const target = zone ? `${uid}|${zone}` : uid;
      const total = Math.round(price + price * 0.014);
      const reff = `trx-${Date.now()}`;

      const res = await fetch("https://forestapi.web.id/api/h2h/deposit/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ api_key: API_KEY, nominal: total, method: "QRISFAST", reff_id: reff, fee_by_customer: true })
      });
      const data = await res.json();
      if (data.status === "success") {
        currentDepositId = data.data.id;
        document.getElementById("qrImage").src = data.data.qr_image_url;
        document.getElementById("hargaDetail").innerText = `Harga: Rp${price} + Fee Admin: Rp${(total - price)} = Total: Rp${total}`;
        document.getElementById("popupQRIS").style.display = "flex";
        pollingInterval = setInterval(() => checkStatus(currentDepositId, code, target, reff), 3000);
      } else {
        alert("Gagal membuat QRIS.");
      }
    }

    async function checkStatus(id, code, target, reff_id) {
      const res = await fetch("https://forestapi.web.id/api/h2h/deposit/status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, api_key: API_KEY })
      });
      const data = await res.json();
      if (data.data.status === "success") {
        document.getElementById("statusPembayaran").innerText = "Pembayaran Berhasil!";
        document.getElementById("statusPembayaran").className = "status-success";
        clearInterval(pollingInterval);
        await fetch("https://forestapi.web.id/api/h2h/transaction/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ product_code: code, target: target, reff_id: reff_id, api_key: API_KEY })
        });
      }
    }

    async function cancelDeposit() {
      if (!currentDepositId) return;
      await fetch("https://forestapi.web.id/api/h2h/deposit/cancel", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: currentDepositId, api_key: API_KEY })
      });
      closePopup();
    }

    function closePopup() {
      clearInterval(pollingInterval);
      document.getElementById("popupQRIS").style.display = "none";
      document.getElementById("statusPembayaran").innerText = "Menunggu Pembayaran...";
      document.getElementById("statusPembayaran").className = "status-pending";
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    fetchProducts();
  </script>
</body>
</html>
