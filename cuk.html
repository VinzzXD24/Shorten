<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VINZZ PPOB</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #2962ff;
    }
    body { padding-bottom: 100px; }
    .navbar { background: var(--primary); }
    .category-btn.active, .subcategory-btn.active {
      background-color: var(--primary)!important; color: white!important;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 30px; height: 30px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .toast-container {
      position: fixed; bottom: 1rem; right: 1rem; z-index: 1055;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">VINZZ PPOB</a>
    </div>
  </nav>

  <div class="container my-4">
    <div id="category-tabs" class="mb-3 d-flex flex-wrap gap-2"></div>
    <div id="subcategory-tabs" class="mb-4 d-flex flex-wrap gap-2"></div>
    
    <div id="loading" class="text-center d-none">
      <div class="loader"></div>
      <p class="mt-2">Memuat produk...</p>
    </div>

    <div class="row g-3" id="products-container"></div>
  </div>

  <!-- Modal QRIS -->
  <div class="modal fade" id="qrisModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content text-center">
        <div class="modal-header">
          <h5 class="modal-title">Bayar dengan QRIS</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Total:</strong> <span id="qris-total">Rp0</span></p>
          <img id="qris-img" src="" alt="QRIS" class="img-fluid mb-3" style="max-height: 250px;">
          <div id="qris-status" class="fw-bold text-warning">Menunggu Pembayaran...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast-container">
    <div id="toastSuccess" class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Pembayaran Berhasil!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_KEY = 'sk-rj6hylkrbx3qio';
    let productsData = [];

    document.addEventListener('DOMContentLoaded', async () => {
      await loadProducts();
    });

    async function loadProducts() {
      toggleLoading(true);
      try {
        const res = await fetch('https://forestapi.web.id/api/h2h/price-list/all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: API_KEY, filter_status: "true", profit_percent: "1" })
        });
        const { data } = await res.json();
        productsData = data;
        renderCategories();
      } catch (e) {
        alert("Gagal memuat produk: " + e.message);
      } finally {
        toggleLoading(false);
      }
    }

    function renderCategories() {
      const categories = [...new Set(productsData.map(p => p.category))];
      const container = document.getElementById('category-tabs');
      container.innerHTML = '';
      categories.forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary category-btn';
        btn.innerText = category;
        btn.onclick = () => {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderSubcategories(category);
        };
        container.appendChild(btn);
      });
      container.firstChild?.click();
    }

    function renderSubcategories(category) {
      const subcats = [...new Set(productsData.filter(p => p.category === category).map(p => p.provider))];
      const container = document.getElementById('subcategory-tabs');
      container.innerHTML = '';
      subcats.forEach(provider => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-secondary subcategory-btn';
        btn.innerText = provider;
        btn.onclick = () => {
          document.querySelectorAll('.subcategory-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderProducts(category, provider);
        };
        container.appendChild(btn);
      });
      container.firstChild?.click();
    }

    function renderProducts(category, provider) {
      const container = document.getElementById('products-container');
      container.innerHTML = '';
      const filtered = productsData.filter(p => p.category === category && p.provider === provider);
      filtered.forEach(product => {
        const card = document.createElement('div');
        card.className = 'col-md-4';
        card.innerHTML = `
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title">${product.name}</h6>
              <div class="text-muted small">${product.provider}</div>
              <div class="text-success fw-bold">${product.formatted_price}</div>
              ${product.note ? `<div class="text-info small mt-1">${product.note}</div>` : ''}
              <button class="btn btn-primary mt-3 w-100" onclick='buyNow(${JSON.stringify(product)})'>Beli Sekarang</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function buyNow(product) {
      let target = '';
      if (product.provider.toLowerCase().includes("mobile legends")) {
        const id = prompt("Masukkan User ID:");
        const zone = prompt("Masukkan Zone ID:");
        if (!id || !zone) return alert("ID tidak lengkap");
        target = `${id}|${zone}`;
      } else {
        target = prompt("Masukkan Nomor Tujuan / User ID:");
        if (!target) return;
      }

      const reff = "trx-" + Date.now();
      const nominal = product.price;

      try {
        const depositRes = await fetch('https://forestapi.web.id/api/h2h/deposit/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            api_key: API_KEY,
            nominal, method: "QRISFAST", reff_id: reff
          })
        });
        const { data } = await depositRes.json();
        showQRIS(data.qr_image_url, product, target, data.id, nominal);
      } catch (err) {
        alert("Gagal membuat deposit: " + err.message);
      }
    }

    function showQRIS(qrUrl, product, target, depositId, nominal) {
      document.getElementById('qris-img').src = qrUrl;
      document.getElementById('qris-total').innerText = `Rp ${nominal.toLocaleString()}`;
      document.getElementById('qris-status').innerText = "Menunggu Pembayaran...";
      new bootstrap.Modal('#qrisModal').show();

      const interval = setInterval(async () => {
        const res = await fetch('https://forestapi.web.id/api/h2h/deposit/cancel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: API_KEY, id: depositId })
        });
        const result = await res.json();
        if (result.data.status === 'success') {
          clearInterval(interval);
          document.getElementById('qris-status').innerText = "Pembayaran Berhasil!";
          document.getElementById('qris-status').classList.replace("text-warning", "text-success");

          const trans = await fetch('https://forestapi.web.id/api/h2h/transaction/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              api_key: API_KEY,
              target, product_code: product.code, reff_id: 'vinzz-' + Date.now()
            })
          });
          const txRes = await trans.json();
          if (txRes.status === 'success') showSuccessToast();
        }
      }, 3000);
    }

    function showSuccessToast() {
      const toast = new bootstrap.Toast(document.getElementById('toastSuccess'));
      toast.show();
    }

    function toggleLoading(show) {
      document.getElementById('loading').classList.toggle('d-none', !show);
      document.getElementById('products-container').classList.toggle('d-none', show);
    }
  </script>
</body>
</html>
