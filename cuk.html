<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vinzz PPOB</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root { --primary: #2962ff; --secondary: #448aff; }
    .navbar { background: var(--primary); }
    .card:hover { transform: translateY(-5px); transition: 0.3s; }
    .category-btn.active { background: var(--primary)!important; color: white!important; }
    .product-img { height: 100px; object-fit: contain; }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">VINZZ PPOB</a>
      <div class="d-flex align-items-center">
        <div id="balance" class="text-white me-3">Saldo: Rp0</div>
        <button class="btn btn-light me-2">Login</button>
        <button class="btn btn-outline-light">Register</button>
      </div>
    </div>
  </nav>

  <div class="container my-5">
    <div class="d-flex flex-wrap gap-2 mb-4" id="category-tabs">
      <button class="btn btn-outline-primary category-btn active" data-category="all">Semua</button>
      <button class="btn btn-outline-primary category-btn" data-category="Pulsa">Pulsa</button>
      <button class="btn btn-outline-primary category-btn" data-category="Games">Games</button>
      <button class="btn btn-outline-primary category-btn" data-category="PLN">PLN</button>
    </div>

    <div id="loading" class="text-center d-none">
      <div class="loader"></div>
      <p class="mt-2">Memuat produk...</p>
    </div>

    <div class="row g-4" id="products-container"></div>

    <div class="modal fade" id="transactionModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Beli Produk</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="transactionForm" onsubmit="handleTransaction(event)">
              <div class="mb-3">
                <label class="form-label">Nomor Tujuan/User ID</label>
                <input type="text" class="form-control" name="target" required />
              </div>
              <input type="hidden" name="product_code" />
              <button type="submit" class="btn btn-primary w-100">
                <span class="submit-text">Beli Sekarang</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_KEY = 'sk-rj6hylkrbx3qio'; // Ganti dengan API key kamu

    document.addEventListener('DOMContentLoaded', async () => {
      await loadProducts();
      setupCategoryFilters();
    });

    async function loadProducts(category = 'all') {
      try {
        showLoading(true);
        const res = await fetch('https://forestapi.web.id/api/h2h/price-list/all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            api_key: API_KEY,
            filter_status: "true",
            profit_percent: "1"
          })
        });

        const { data } = await res.json();
        const filtered = category === 'all' ? data : data.filter(p => p.category === category);
        renderProducts(filtered);
      } catch (err) {
        alert('Gagal memuat produk: ' + err.message);
      } finally {
        showLoading(false);
      }
    }

    function renderProducts(products) {
      const container = document.getElementById('products-container');
      container.innerHTML = '';
      products.forEach(p => {
        container.innerHTML += `
          <div class="col-md-4 col-lg-3">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">${p.name}</h6>
                <div class="text-muted small">${p.provider}</div>
                <div class="text-success fw-bold mt-2">${p.formatted_price}</div>
                ${p.note ? `<div class="text-info small mt-2">${p.note}</div>` : ''}
                <button onclick="openTransactionModal('${p.code}')" class="btn btn-primary w-100 mt-3">Beli</button>
              </div>
            </div>
          </div>
        `;
      });
    }

    function openTransactionModal(productCode) {
      const modal = new bootstrap.Modal('#transactionModal');
      document.querySelector('#transactionForm input[name="product_code"]').value = productCode;
      modal.show();
    }

    async function handleTransaction(e) {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');
      const data = new FormData(form);

      try {
        btn.disabled = true;
        btn.querySelector('.submit-text').classList.add('d-none');
        btn.querySelector('.spinner-border').classList.remove('d-none');

        const res = await fetch('https://forestapi.web.id/api/h2h/transaction/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            api_key: API_KEY,
            product_code: data.get('product_code'),
            target: data.get('target'),
            reff_id: 'vinzz-' + Date.now()
          })
        });

        const result = await res.json();
        if (result.status === 'success') {
          alert(`Transaksi Berhasil!\nSN: ${result.data.serial_number}`);
          bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
        } else {
          throw new Error(result.message || 'Transaksi gagal');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.querySelector('.submit-text').classList.remove('d-none');
        btn.querySelector('.spinner-border').classList.add('d-none');
      }
    }

    function setupCategoryFilters() {
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          loadProducts(btn.dataset.category);
        });
      });
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('d-none', !show);
      document.getElementById('products-container').classList.toggle('d-none', show);
    }
  </script>
</body>
</html>
