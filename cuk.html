<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog Produk Digital</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1f2937;
      color: white;
      padding: 1em;
      text-align: center;
    }
    .kategori-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1em;
      margin-top: 1em;
    }
    .kategori-header button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.5em 1em;
      border-radius: 10px;
      cursor: pointer;
    }
    .subkategori-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 1em auto;
      gap: 0.5em;
      max-width: 90%;
    }
    .subkategori-container button {
      background: #10b981;
      color: white;
      border: none;
      padding: 0.3em 0.8em;
      border-radius: 8px;
      cursor: pointer;
    }
    .produk-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 1em;
      gap: 1em;
    }
    .produk {
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 1em;
      width: 250px;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }
    .produk h3 {
      margin: 0;
      font-size: 1.1em;
    }
    .produk input {
      padding: 0.4em;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    .produk button {
      background: #ef4444;
      color: white;
      border: none;
      padding: 0.5em;
      border-radius: 8px;
      cursor: pointer;
    }
    .floating-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #9333ea;
      color: white;
      padding: 1em;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .notif {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #22c55e;
      color: white;
      padding: 1em 2em;
      border-radius: 10px;
      animation: fade 3s ease-out forwards;
      z-index: 1000;
    }
    @keyframes fade {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Katalog Produk Digital</h1>
    <div class="kategori-header" id="kategoriHeader"></div>
    <div class="subkategori-container" id="subKategoriContainer"></div>
  </header>

  <main>
    <div class="produk-container" id="produkContainer">Memuat produk...</div>
  </main>

  <div class="floating-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
    &#8679;
  </div>

  <script>
    const apiKey = "sk-rj6hylkrbx3qio";
    let produkData = [];
    let currentKategori = "";
    let currentSub = "";

    async function fetchProduk() {
      try {
        const res = await fetch("https://forestapi.web.id/api/h2h/price-list/all", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ api_key: apiKey, filter_status: false })
        });
        const json = await res.json();
        produkData = json.data;
        buildKategori();
      } catch (err) {
        document.getElementById("produkContainer").innerHTML = "Gagal memuat produk";
      }
    }

    function buildKategori() {
      const kategoriMap = {};
      produkData.forEach(p => {
        if (!kategoriMap[p.category]) kategoriMap[p.category] = new Set();
        kategoriMap[p.category].add(p.provider);
      });
      const header = document.getElementById("kategoriHeader");
      header.innerHTML = "";
      for (const kategori in kategoriMap) {
        const btn = document.createElement("button");
        btn.innerText = kategori;
        btn.onclick = () => {
          currentKategori = kategori;
          buildSubKategori([...kategoriMap[kategori]]);
        };
        header.appendChild(btn);
      }
    }

    function buildSubKategori(subs) {
      const sub = document.getElementById("subKategoriContainer");
      sub.innerHTML = "";
      subs.forEach(s => {
        const b = document.createElement("button");
        b.innerText = s;
        b.onclick = () => {
          currentSub = s;
          showProduk(currentKategori, currentSub);
        };
        sub.appendChild(b);
      });
    }

    function showProduk(kat, sub) {
      const container = document.getElementById("produkContainer");
      const filtered = produkData.filter(p => p.category === kat && p.provider === sub);
      container.innerHTML = "";
      filtered.forEach(prod => {
        const div = document.createElement("div");
        div.className = "produk";
        div.innerHTML = `
          <h3>${prod.name}</h3>
          <p>${prod.formatted_price}</p>
          <input type="text" placeholder="${prod.provider.includes('MOBILE LEGENDS') ? 'User ID' : 'Nomor Tujuan'}" id="input-${prod.code}">
          ${prod.provider.includes('MOBILE LEGENDS') ? '<input type="text" placeholder="Zone ID" id="zone-'+prod.code+'">' : ''}
          <button onclick="beliProduk('${prod.code}', '${prod.name}', ${prod.price}, '${prod.provider}')">Beli Sekarang</button>
        `;
        container.appendChild(div);
      });
    }

    function showNotif(msg) {
      const notif = document.createElement("div");
      notif.className = "notif";
      notif.innerText = msg;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    async function beliProduk(code, name, price, provider) {
      const input = document.getElementById("input-"+code).value.trim();
      const zone = provider.includes("MOBILE LEGENDS") ? document.getElementById("zone-"+code).value.trim() : "";
      if (!input || (provider.includes("MOBILE LEGENDS") && !zone)) return alert("Lengkapi data pengguna terlebih dahulu!");
      const target = zone ? `${input}|${zone}` : input;
      const reff = `trx-${Date.now()}`;
      try {
        const qres = await fetch("https://forestapi.web.id/api/h2h/deposit/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nominal: price,
            method: "QRISFAST",
            reff_id: reff,
            api_key: apiKey
          })
        });
        const qjson = await qres.json();
        if (qjson.status !== "success") return alert("Gagal membuat QRIS");

        const qimg = qjson.data.qr_image_url;
        const id = qjson.data.id;
        const modal = window.open("", "QRIS Payment", "width=400,height=600");
        modal.document.write(`<h2>Scan QRIS untuk bayar</h2><img src="${qimg}" width="300"><p id="status">Menunggu pembayaran...</p><button onclick="window.close()">Tutup</button>`);

        const interval = setInterval(async () => {
          const check = await fetch("https://forestapi.web.id/api/h2h/deposit/cancel", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: id, api_key: apiKey })
          });
          const cekJson = await check.json();
          if (cekJson.data.status === "success") {
            clearInterval(interval);
            modal.document.getElementById("status").innerText = "Pembayaran berhasil! Memproses...";
            showNotif("Pembayaran sukses, transaksi diproses...");
            await fetch("https://forestapi.web.id/api/h2h/transaction/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                product_code: code,
                target: target,
                reff_id: reff,
                api_key: apiKey
              })
            });
          }
        }, 5000);
      } catch (e) {
        alert("Terjadi kesalahan saat memproses pembayaran.");
      }
    }

    fetchProduk();
  </script>
</body>
</html>
