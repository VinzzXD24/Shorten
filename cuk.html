<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vinzz PPOB</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #2962ff;
    }
    .navbar { background-color: var(--primary); }
    .category-btn.active { background-color: var(--primary) !important; color: #fff !important; }
    .product-img { height: 100px; object-fit: contain; }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#">VINZZ PPOB</a>
  </div>
</nav>

<div class="container my-4">
  <!-- Category Filter -->
  <div class="d-flex flex-wrap gap-2 mb-3" id="category-tabs"></div>

  <!-- Loading -->
  <div id="loading" class="text-center d-none">
    <div class="loader"></div>
    <p>Memuat produk...</p>
  </div>

  <!-- Produk -->
  <div class="row g-3" id="products-container"></div>
</div>

<!-- Modal QRIS -->
<div class="modal fade" id="qrisModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header">
        <h5 class="modal-title">Pembayaran QRIS</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Scan QRIS berikut untuk membayar:</p>
        <img id="qrisImage" src="" alt="QRIS" class="img-fluid mb-3"/>
        <p id="qrisStatus" class="text-muted">Menunggu pembayaran...</p>
        <button class="btn btn-danger w-100" onclick="cancelDeposit()">Batalkan</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_KEY = "sk-rj6hylkrbx3qio";
let allProducts = [];
let currentDepositId = "";

document.addEventListener("DOMContentLoaded", () => {
  loadProducts();
});

async function loadProducts() {
  showLoading(true);
  try {
    const res = await fetch("https://forestapi.web.id/api/h2h/price-list/all", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ api_key: API_KEY, filter_status: "true", profit_percent: "1" })
    });
    const json = await res.json();
    if (json.status !== "success") throw new Error(json.message);
    allProducts = json.data;
    renderCategories();
    renderProducts("all");
  } catch (err) {
    alert("Gagal memuat produk: " + err.message);
  } finally {
    showLoading(false);
  }
}

function renderCategories() {
  const tabs = document.getElementById("category-tabs");
  const categories = [...new Set(allProducts.map(p => p.category))];
  tabs.innerHTML = `<button class="btn btn-outline-primary category-btn active" data-category="all">Semua</button>` +
    categories.map(c => `<button class="btn btn-outline-primary category-btn" data-category="${c}">${c}</button>`).join("");
  document.querySelectorAll(".category-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderProducts(btn.dataset.category);
    });
  });
}

function renderProducts(category) {
  const container = document.getElementById("products-container");
  container.innerHTML = "";
  const filtered = category === "all" ? allProducts : allProducts.filter(p => p.category === category);
  filtered.forEach(p => {
    const el = document.createElement("div");
    el.className = "col-md-3";
    el.innerHTML = `
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h6 class="card-title">${p.name}</h6>
          <p class="text-muted small">${p.provider}</p>
          <p class="fw-bold text-success">${p.formatted_price}</p>
          ${p.note ? `<p class="text-info small">${p.note}</p>` : ""}
          <input class="form-control mb-2" placeholder="User ID / Nomor" id="input-${p.code}"/>
          <button class="btn btn-primary w-100" onclick="payNow('${p.code}')">Beli Sekarang</button>
        </div>
      </div>`;
    container.appendChild(el);
  });
}

async function payNow(code) {
  const input = document.getElementById("input-" + code);
  const target = input.value.trim();
  if (!target) return alert("Masukkan ID atau Nomor Tujuan!");

  const reff_id = "order-" + Date.now();

  // Buat deposit QRIS terlebih dahulu
  try {
    const deposit = await fetch("https://forestapi.web.id/api/h2h/deposit/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        api_key: API_KEY,
        nominal: 1000, // bisa pakai harga produk sebenarnya jika tersedia
        method: "QRISFAST",
        reff_id
      })
    });
    const res = await deposit.json();
    if (res.status !== "success") throw new Error(res.message);
    currentDepositId = res.data.id;

    // Tampilkan QRIS
    document.getElementById("qrisImage").src = res.data.qr_image_url;
    document.getElementById("qrisStatus").innerText = "Menunggu pembayaran...";
    new bootstrap.Modal('#qrisModal').show();

    // Cek status otomatis
    const interval = setInterval(async () => {
      const check = await fetch("https://forestapi.web.id/api/h2h/deposit/methods", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ api_key: API_KEY })
      });
      if (document.getElementById("qrisStatus").innerText !== "Menunggu pembayaran...") return clearInterval(interval);

      // Lanjutkan transaksi produk setelah QRIS berhasil
      const confirm = await fetch("https://forestapi.web.id/api/h2h/transaction/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          api_key: API_KEY,
          product_code: code,
          target: target,
          reff_id
        })
      });
      const result = await confirm.json();
      if (result.status === "success") {
        document.getElementById("qrisStatus").innerText = "Transaksi berhasil! SN: " + result.data.serial_number;
        clearInterval(interval);
      }
    }, 5000);
  } catch (err) {
    alert("Gagal: " + err.message);
  }
}

async function cancelDeposit() {
  if (!currentDepositId) return;
  try {
    await fetch("https://forestapi.web.id/api/h2h/deposit/cancel", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ api_key: API_KEY, id: currentDepositId })
    });
    document.getElementById("qrisStatus").innerText = "Transaksi dibatalkan.";
  } catch (e) {
    alert("Gagal membatalkan.");
  }
}

function showLoading(show) {
  document.getElementById("loading").classList.toggle("d-none", !show);
  document.getElementById("products-container").classList.toggle("d-none", show);
}
</script>
</body>
</html>
