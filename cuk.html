<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Katalog Produk Digital</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
      color: #333;
    }
    header {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    header button {
      background: white;
      color: #4CAF50;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .container {
      padding: 20px;
    }
    .product-group {
      margin-bottom: 30px;
    }
    .product {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .product button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .qris-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      display: none;
    }
    .qris-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      max-width: 300px;
    }
    .status-pending {
      color: orange;
      font-weight: bold;
    }
    .status-success {
      color: green;
      font-weight: bold;
      animation: pop 0.3s ease-in-out;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    input {
      padding: 5px;
      margin-top: 8px;
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

<header id="categoryTabs"></header>

<div class="container" id="productContainer">Memuat produk...</div>

<div class="qris-modal" id="qrisModal">
  <div class="qris-box">
    <h3>Scan QRIS</h3>
    <img id="qrImage" src="" alt="QRIS" width="200"/>
    <p id="statusText" class="status-pending">Menunggu pembayaran...</p>
    <button onclick="cancelDeposit()">Batalkan</button>
  </div>
</div>

<script>
const API_KEY = "sk-rj6hylkrbx3qio";
const API_BASE = "https://forestapi.web.id/api/h2h";
let currentDepositId = null;
let pollingInterval = null;
let selectedProduct = null;

async function fetchProducts() {
  try {
    const res = await fetch(`${API_BASE}/price-list/all`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ api_key: API_KEY, filter_status: true, profit_percent: "1" })
    });
    const data = await res.json();
    return data.data;
  } catch (err) {
    document.getElementById("productContainer").innerText = "Gagal memuat produk.";
    return [];
  }
}

function groupByCategoryAndProvider(products) {
  const grouped = {};
  for (const p of products) {
    if (!grouped[p.category]) grouped[p.category] = {};
    if (!grouped[p.category][p.provider]) grouped[p.category][p.provider] = [];
    grouped[p.category][p.provider].push(p);
  }
  return grouped;
}

function renderCategoryTabs(categories) {
  const header = document.getElementById("categoryTabs");
  header.innerHTML = "";
  for (const cat of categories) {
    const btn = document.createElement("button");
    btn.innerText = cat;
    btn.onclick = () => showCategory(cat);
    header.appendChild(btn);
  }
}

function showCategory(catName) {
  const grouped = window.groupedProducts;
  const container = document.getElementById("productContainer");
  container.innerHTML = "";

  for (const provider in grouped[catName]) {
    const groupEl = document.createElement("div");
    groupEl.className = "product-group";
    groupEl.innerHTML = `<h3>${provider}</h3>`;

    grouped[catName][provider].forEach(prod => {
      const el = document.createElement("div");
      el.className = "product";

      let inputHtml = '';
      if (prod.name.includes("Mobile Legends")) {
        inputHtml = `
          <input placeholder="User ID" id="uid-${prod.code}" />
          <input placeholder="Zone ID" id="zone-${prod.code}" />
        `;
      } else {
        inputHtml = `<input placeholder="Nomor Tujuan / ID" id="uid-${prod.code}" />`;
      }

      el.innerHTML = `
        <strong>${prod.name}</strong><br>
        <small>${prod.formatted_price}</small><br>
        ${inputHtml}
        <button onclick='buyProduct(${JSON.stringify(prod)})'>Beli Sekarang</button>
      `;
      groupEl.appendChild(el);
    });

    container.appendChild(groupEl);
  }
}

async function buyProduct(prod) {
  selectedProduct = prod;
  let target = "";
  if (prod.name.includes("Mobile Legends")) {
    const uid = document.getElementById(`uid-${prod.code}`).value.trim();
    const zid = document.getElementById(`zone-${prod.code}`).value.trim();
    if (!uid || !zid) return alert("Lengkapi User ID dan Zone ID");
    target = `${uid}|${zid}`;
  } else {
    const val = document.getElementById(`uid-${prod.code}`).value.trim();
    if (!val) return alert("Isi nomor tujuan terlebih dahulu");
    target = val;
  }

  const deposit = await fetch(`${API_BASE}/deposit/create`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      api_key: API_KEY,
      method: "QRISFAST",
      nominal: prod.price,
      reff_id: "qris-" + Date.now(),
      fee_by_customer: "false"
    })
  }).then(r => r.json());

  if (deposit.status !== "success") return alert("Gagal membuat QRIS");

  currentDepositId = deposit.data.id;
  document.getElementById("qrImage").src = deposit.data.qr_image_url;
  document.getElementById("statusText").className = "status-pending";
  document.getElementById("statusText").innerText = "Menunggu pembayaran...";
  document.getElementById("qrisModal").style.display = "flex";

  pollingInterval = setInterval(checkStatus, 3000);
}

async function checkStatus() {
  const res = await fetch(`${API_BASE}/deposit/methods`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ api_key: API_KEY })
  }).then(r => r.json());

  const statusCheck = await fetch(`${API_BASE}/deposit/cancel`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ api_key: API_KEY, id: currentDepositId })
  }).then(r => r.json());

  if (statusCheck.data.status === "success") {
    clearInterval(pollingInterval);
    document.getElementById("statusText").className = "status-success";
    document.getElementById("statusText").innerText = "Pembayaran berhasil!";

    // Lanjut transaksi
    await fetch(`${API_BASE}/transaction/create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        api_key: API_KEY,
        product_code: selectedProduct.code,
        target: selectedProduct.name.includes("Mobile Legends")
          ? `${document.getElementById(`uid-${selectedProduct.code}`).value}|${document.getElementById(`zone-${selectedProduct.code}`).value}`
          : document.getElementById(`uid-${selectedProduct.code}`).value,
        reff_id: "trx-" + Date.now()
      })
    });

    setTimeout(() => {
      document.getElementById("qrisModal").style.display = "none";
    }, 3000);
  }
}

async function cancelDeposit() {
  clearInterval(pollingInterval);
  await fetch(`${API_BASE}/deposit/cancel`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: currentDepositId, api_key: API_KEY })
  });
  document.getElementById("qrisModal").style.display = "none";
  alert("Pesanan dibatalkan");
}

(async () => {
  const allProducts = await fetchProducts();
  const grouped = groupByCategoryAndProvider(allProducts);
  window.groupedProducts = grouped;
  renderCategoryTabs(Object.keys(grouped));
  showCategory(Object.keys(grouped)[0]);
})();
</script>
</body>
</html>
