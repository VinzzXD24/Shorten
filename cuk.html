<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VINZZ PPOB</title>
  <style>
    :root {
      --bg: #fff;
      --text: #111;
      --primary: #e91e63;
      --card: #f9f9f9;
    }
    [data-theme="dark"] {
      --bg: #121212;
      --text: #eee;
      --primary: #ff4081;
      --card: #1e1e1e;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--primary);
      color: #fff;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .toggle-switch {
      display: flex;
      align-items: center;
    }
    .toggle-switch input {
      display: none;
    }
    .toggle-switch label {
      background: #ccc;
      width: 50px;
      height: 25px;
      border-radius: 25px;
      cursor: pointer;
      position: relative;
    }
    .toggle-switch label::after {
      content: "";
      width: 20px;
      height: 20px;
      background: #fff;
      position: absolute;
      top: 2.5px;
      left: 3px;
      border-radius: 50%;
      transition: 0.3s;
    }
    .toggle-switch input:checked + label::after {
      left: 27px;
    }
    .category-nav, .subcategory-nav {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      padding: 1rem;
    }
    .category-nav button, .subcategory-nav button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      cursor: pointer;
    }
    .products {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .product-card {
      background: var(--card);
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .product-card input {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .product-card button {
      margin-top: 0.5rem;
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.5rem;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
    }
    .popup {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 2px solid var(--primary);
      padding: 1rem;
      z-index: 1000;
      border-radius: 1rem;
      display: none;
    }
    .popup.show {
      display: block;
    }
    .popup img {
      width: 200px;
      height: 200px;
      margin: 0 auto;
      display: block;
    }
    .popup h3, .popup p {
      text-align: center;
    }
    .popup .close-btn, .popup .cancel-btn {
      margin-top: 1rem;
      display: block;
      width: 100%;
      padding: 0.5rem;
      border: none;
      border-radius: 0.5rem;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
    }
    #scrollTop {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.8rem;
      border-radius: 50%;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>VINZZ PPOB</h1>
    <div class="toggle-switch">
      <input type="checkbox" id="theme-toggle" />
      <label for="theme-toggle"></label>
    </div>
  </header>

  <div class="category-nav" id="categoryNav"></div>
  <div class="subcategory-nav" id="subcategoryNav"></div>
  <div class="products" id="productList"></div>

  <div class="popup" id="qrisPopup">
    <h3>Scan QRIS</h3>
    <img id="qrImage" src="" alt="QR Code"/>
    <p id="paymentInfo">Menunggu pembayaran...</p>
    <p id="feeInfo"></p>
    <button class="cancel-btn" onclick="cancelDeposit()">Batalkan</button>
    <button class="close-btn" onclick="closePopup()">Tutup</button>
  </div>

  <button id="scrollTop" onclick="scrollToTop()">â†‘</button>

  <script>
    const API_KEY = "sk-rj6hylkrbx3qio";
    let allProducts = [];
    let currentCategory = '';
    let pollingInterval;
    let currentDepositId = '';

    async function fetchProducts() {
      const res = await fetch("https://forestapi.web.id/api/h2h/price-list/all", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ api_key: API_KEY, profit_percent: "1", filter_status: "true" })
      });
      const data = await res.json();
      allProducts = data.data || [];
      renderCategories();
    }

    function renderCategories() {
      const categoryNav = document.getElementById("categoryNav");
      const categories = [...new Set(allProducts.map(p => p.category))];
      categoryNav.innerHTML = '';
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.onclick = () => {
          currentCategory = cat;
          renderSubcategories(cat);
        };
        categoryNav.appendChild(btn);
      });
    }

    function renderSubcategories(category) {
      const subcategoryNav = document.getElementById("subcategoryNav");
      const subs = [...new Set(allProducts.filter(p => p.category === category).map(p => p.provider))];
      subcategoryNav.innerHTML = '';
      subs.forEach(sub => {
        const btn = document.createElement("button");
        btn.textContent = sub;
        btn.onclick = () => {
          renderProducts(currentCategory, sub);
        };
        subcategoryNav.appendChild(btn);
      });
    }

    function renderProducts(category, provider) {
      const productList = document.getElementById("productList");
      const filtered = allProducts.filter(p => p.category === category && p.provider === provider);
      productList.innerHTML = '';
      filtered.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <h4>${p.name}</h4>
          <p><b>${p.formatted_price}</b> (${p.type})</p>
          <p>${p.note || ''}</p>
          <input type="text" placeholder="${p.provider.includes('LEGENDS') ? 'User ID' : 'Nomor Tujuan'}" id="input-${p.code}" />
          <input type="text" placeholder="${p.provider.includes('LEGENDS') ? 'Zone ID' : ''}" id="zone-${p.code}" ${p.provider.includes('LEGENDS') ? '' : 'style="display:none;"'} />
          <button onclick="buyProduct('${p.code}', '${p.price}', '${p.provider}')">Beli Sekarang</button>
        `;
        productList.appendChild(card);
      });
    }

    async function buyProduct(code, price, provider) {
      let target = document.getElementById(`input-${code}`).value.trim();
      if (provider.includes('LEGENDS')) {
        const zone = document.getElementById(`zone-${code}`).value.trim();
        if (!target || !zone) return alert("Isi User ID dan Zone ID");
        target = `${target}|${zone}`;
      } else {
        if (!target) return alert("Isi nomor tujuan");
      }

      const nominal = parseInt(price);
      const reff = "trx-" + Date.now();

      const res = await fetch("https://forestapi.web.id/api/h2h/deposit/create", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ nominal, method: "QRISFAST", reff_id: reff, api_key: API_KEY })
      });
      const data = await res.json();
      if (data.status !== "success") return alert("Gagal membuat QRIS");

      const qrImg = data.data.qr_image_url;
      currentDepositId = data.data.id;

      document.getElementById("qrImage").src = qrImg;
      document.getElementById("paymentInfo").textContent = "Menunggu pembayaran...";
      document.getElementById("feeInfo").textContent = `Total: Rp ${price}, Fee Admin: Rp ${data.data.fee}, Total Bayar: Rp ${price + data.data.fee}`;
      document.getElementById("qrisPopup").classList.add("show");

      if (pollingInterval) clearInterval(pollingInterval);
      pollingInterval = setInterval(() => checkDepositStatus(data.data.id), 4000);
    }

    async function checkDepositStatus(id) {
      const res = await fetch("https://forestapi.web.id/api/h2h/deposit/status", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ id, api_key: API_KEY })
      });
      const data = await res.json();
      if (data.data.status === "success") {
        clearInterval(pollingInterval);
        document.getElementById("paymentInfo").textContent = "Pembayaran Berhasil!";
      }
    }

    async function cancelDeposit() {
      if (!currentDepositId) return;
      await fetch("https://forestapi.web.id/api/h2h/deposit/cancel", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ id: currentDepositId, api_key: API_KEY })
      });
      clearInterval(pollingInterval);
      closePopup();
    }

    function closePopup() {
      document.getElementById("qrisPopup").classList.remove("show");
      currentDepositId = '';
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById("theme-toggle").addEventListener("change", (e) => {
      document.documentElement.setAttribute("data-theme", e.target.checked ? "dark" : "light");
    });

    fetchProducts();
  </script>
</body>
</html>
