<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VINZZ PPOB</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #2962ff;
    }
    .navbar { background-color: var(--primary); }
    .card:hover { transform: translateY(-4px); transition: 0.3s; }
    .category-btn.active { background: var(--primary)!important; color: white!important; }
    .product-img { height: 100px; object-fit: contain; }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 30px; height: 30px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .qris-status.success {
      color: green; font-weight: bold;
      animation: pulse 0.6s ease-in-out infinite alternate;
    }
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">VINZZ PPOB</a>
    </div>
  </nav>

  <div class="container my-4">
    <div id="category-tabs" class="d-flex flex-wrap gap-2 mb-3"></div>
    <div id="provider-tabs" class="d-flex flex-wrap gap-2 mb-3"></div>
    <div id="loading" class="text-center d-none">
      <div class="loader"></div>
      <p class="mt-2">Memuat produk...</p>
    </div>
    <div class="row g-3" id="products-container"></div>
  </div>

  <!-- Modal QRIS -->
  <div class="modal fade" id="qrisModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-3">
        <h5 class="mb-2">Bayar dengan QRIS</h5>
        <img id="qrisImage" src="" alt="QRIS" class="img-fluid rounded mb-2"/>
        <div id="qrisStatus" class="text-warning mb-2">Menunggu pembayaran...</div>
        <button class="btn btn-danger btn-sm" onclick="cancelDeposit()">Batalkan</button>
      </div>
    </div>
  </div>

  <script>
    const API_KEY = 'sk-rj6hylkrbx3qio';
    let allProducts = [], selectedCategory = 'all', selectedProvider = 'all';
    let pollingInterval, currentDepositId, currentProduct;

    document.addEventListener('DOMContentLoaded', () => loadProducts());

    async function loadProducts() {
      showLoading(true);
      try {
        const res = await fetch('https://forestapi.web.id/api/h2h/price-list/all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: API_KEY, profit_percent: "1", filter_status: "true" })
        });
        const json = await res.json();
        allProducts = json.data;
        renderCategories();
        renderProviders();
        renderProducts();
      } catch (err) {
        alert('Gagal memuat produk: ' + err.message);
      } finally {
        showLoading(false);
      }
    }

    function renderCategories() {
      const categories = ['all', ...new Set(allProducts.map(p => p.category))];
      const container = document.getElementById('category-tabs');
      container.innerHTML = '';
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = `btn btn-outline-primary category-btn ${cat === 'all' ? 'active' : ''}`;
        btn.textContent = cat;
        btn.onclick = () => {
          selectedCategory = cat;
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderProviders();
          renderProducts();
        };
        container.appendChild(btn);
      });
    }

    function renderProviders() {
      const providers = ['all', ...new Set(allProducts.filter(p => selectedCategory === 'all' || p.category === selectedCategory).map(p => p.provider))];
      const container = document.getElementById('provider-tabs');
      container.innerHTML = '';
      providers.forEach(prov => {
        const btn = document.createElement('button');
        btn.className = `btn btn-outline-secondary provider-btn ${prov === 'all' ? 'active' : ''}`;
        btn.textContent = prov;
        btn.onclick = () => {
          selectedProvider = prov;
          document.querySelectorAll('.provider-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderProducts();
        };
        container.appendChild(btn);
      });
    }

    function renderProducts() {
      const container = document.getElementById('products-container');
      const filtered = allProducts.filter(p =>
        (selectedCategory === 'all' || p.category === selectedCategory) &&
        (selectedProvider === 'all' || p.provider === selectedProvider)
      );
      container.innerHTML = filtered.map(product => `
        <div class="col-sm-6 col-md-4 col-lg-3">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <h6>${product.name}</h6>
              <small class="text-muted">${product.provider}</small>
              <div class="fw-bold text-success mt-auto mb-2">${product.formatted_price}</div>
              ${product.note ? `<div class="text-info small">${product.note}</div>` : ''}
              ${product.provider.includes('MOBILE LEGENDS') ? `
                <div class="input-group input-group-sm mb-2">
                  <input type="text" class="form-control" placeholder="User ID" id="uid-${product.code}">
                  <input type="text" class="form-control" placeholder="Zone ID" id="zid-${product.code}">
                </div>` : `
                <input type="text" class="form-control form-control-sm mb-2" placeholder="Nomor/User ID" id="target-${product.code}">`}
              <button class="btn btn-primary btn-sm w-100" onclick="buyProduct('${product.code}')">Beli Sekarang</button>
            </div>
          </div>
        </div>`).join('');
    }

    async function buyProduct(code) {
      const product = allProducts.find(p => p.code === code);
      if (!product) return alert('Produk tidak ditemukan.');

      let target;
      if (product.provider.includes('MOBILE LEGENDS')) {
        const uid = document.getElementById(`uid-${code}`).value;
        const zid = document.getElementById(`zid-${code}`).value;
        if (!uid || !zid) return alert('Masukkan User ID dan Zone ID.');
        target = `${uid}|${zid}`;
      } else {
        target = document.getElementById(`target-${code}`).value;
        if (!target) return alert('Masukkan tujuan.');
      }

      const nominal = product.price;
      const reffId = 'topup-' + Date.now();

      try {
        const res = await fetch('https://forestapi.web.id/api/h2h/deposit/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            api_key: API_KEY,
            method: 'QRISFAST',
            nominal,
            reff_id: reffId,
            fee_by_customer: false
          })
        });
        const json = await res.json();
        if (json.status !== 'success') throw new Error(json.message);

        currentDepositId = json.data.id;
        currentProduct = { product_code: product.code, target, reff_id: reffId };
        document.getElementById('qrisImage').src = json.data.qr_image_url;
        document.getElementById('qrisStatus').textContent = 'Menunggu pembayaran...';
        document.getElementById('qrisStatus').classList.remove('success');
        new bootstrap.Modal('#qrisModal').show();
        pollingInterval = setInterval(checkDepositStatus, 5000);
      } catch (err) {
        alert('Gagal membuat QRIS: ' + err.message);
      }
    }

    async function checkDepositStatus() {
      try {
        const res = await fetch('https://forestapi.web.id/api/h2h/deposit/cancel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: API_KEY, id: currentDepositId })
        });
        const json = await res.json();
        if (json.data.status === 'success') {
          clearInterval(pollingInterval);
          document.getElementById('qrisStatus').textContent = 'Pembayaran berhasil!';
          document.getElementById('qrisStatus').classList.add('success');
          await processTransaction();
          setTimeout(() => bootstrap.Modal.getInstance(document.getElementById('qrisModal')).hide(), 3000);
        }
      } catch (e) {}
    }

    async function processTransaction() {
      try {
        const res = await fetch('https://forestapi.web.id/api/h2h/transaction/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: API_KEY, ...currentProduct })
        });
        const json = await res.json();
        if (json.status === 'success') {
          alert(`Transaksi sukses!\nSN: ${json.data.serial_number}`);
        } else {
          alert('Gagal proses transaksi.');
        }
      } catch (e) {
        alert('Error proses transaksi.');
      }
    }

    async function cancelDeposit() {
      try {
        clearInterval(pollingInterval);
        await fetch('https://forestapi.web.id/api/h2h/deposit/cancel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: API_KEY, id: currentDepositId })
        });
        bootstrap.Modal.getInstance(document.getElementById('qrisModal')).hide();
        alert('Pesanan dibatalkan.');
      } catch (e) {
        alert('Gagal membatalkan.');
      }
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('d-none', !show);
      document.getElementById('products-container').classList.toggle('d-none', show);
    }
  </script>
</body>
</html>
